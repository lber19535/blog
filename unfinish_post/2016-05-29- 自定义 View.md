---
title:        "自定义 View"
date:         2016-05-29 17:00
categories:   Android
list_number:  false
tags:
- Android
---

在看了官方文档的[自定义 View](https://developer.android.com/training/custom-views/index.html)之后决定写一个比较详细的东西来记录这个学习过程。这篇文章会先从 View 的工作流程以及和 Activity 之间的关系说起，然后对常用的绘制工具（Matrix，Rect，Paint，Drawable，Bitmap，Canvas 等）做一些简单的介绍，最后写一个自定义的布局和一个自定义的 View。

<!--more-->
## 1.Activity 与 View 
首先 Activity 既不是 View 也不是 Window，其次 Activity 和 Window 还有 View 之间的关系可以简单的理解为下图：

![](http://7xisp0.com1.z0.glb.clouddn.com/activity_view_ship.png)

看起来就像是俄罗斯套娃，最终我们在 Activity 中使用 setContentView 的时候实际上是 decorview 将我们传入的 layout 放到了 contentview 这个地方，decorview 本身是一个 Framlayout。另外 Activity 和 View 之间有联系的是触摸事件，由于之前写过一篇比较详细的触摸事件分析的[文章](http://lber19535.github.io/2015/04/27/2015-2015-04-27-Android%E8%A7%A6%E6%91%B8%E7%B3%BB%E7%BB%9F/)，这里就不展开说了。

以上差不多就是 Activity 和 View 之间的一个简单的关系，更为详细的内容在自定义 View 里用不到，感兴趣的可以到参考部分看下。

## 2.View 和 ViewGroup
View 和 ViewGroup 大家再熟悉不过了，其中 ViewGroup 继承自 View，添加了一些对子 View 管理的方法，例如 addView。当一个 View 被 add 到一个 ViewGroup 上的时候会经过下面这个流程：
![](http://i.stack.imgur.com/MDJXT.png)
图片来源：[Google +](https://plus.google.com/+ArpitMathur/posts/cT1EuBbxEgN)

### 2.1 Measure
在 measure 阶段会确定这个 View 尺寸，View 大小通常由自身的内容和 xml 中的属性共同决定，其中 padding 也是算在 View 大小中的，而 margin 不算。在设置大小的时候还需要注意 MeasureSpec，MeasureSpec 封装了父控件对子控件布局的需求，每个 spec 中包含有对应的 mode 和 size，这里有三种 mode 可供选择：
* **UNSPECIFIED** 父控件不对子控件有要求，子控件的尺寸可以随意定制
* **EXACTLY** 父控件来确定子控件大小，不管子控件设置了多大
* **AT_MOST** 父控件只规定了最大值，没有规定最小值，子控件的大小只要小于等于父控件规定的大小即可

mode 和 layout_width、layout_height 之间没有一对一的关系，子控件的 mode 和 layout 取决于父控件的 mode。

下面我们看下这三个 mode 和对应的大小之间的关系：
当父控件是 **EXACTLY** 时 :

|child layout|mode|size|
|------------|----|----|
|指定大小|EXACTLY|子控件自己指定大小，当没有调用 setMeasuredDimension 的时候大小由 |
|MATCH_PARENT|EXACTLY|父控件多大子控件就多大|
|WRAP_CONTENT|AT_MOST||
### 2.2 Layout

### 2.3 Draw


## 3.






## 参考：
[Android应用程序窗口（Activity）的窗口对象（Window）的创建过程分析](http://blog.csdn.net/luoshengyang/article/details/8223770)
[窗口机制分析与UI管理系统](http://www.cnblogs.com/lcw/p/3372914.html)
[Android中View大小的确定过程](http://www.liaohuqiu.net/cn/posts/how-does-android-caculate-the-size-of-child-view/