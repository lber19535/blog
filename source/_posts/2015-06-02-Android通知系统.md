---
title:        "Android 通知"
date:         2015-6-02 17:00
categories:   Android
tags:
- Android
- API
---

对API的简单翻译

<!--more-->

通知是一种独立于APP的UI外的一种消息显示方式。当你告诉系统需要发送一个通知时，首先他会显示一个图标在通知栏区域。下拉则可以看到通知的详细信息（原文把这里比作抽屉）。通知栏区域和下拉的区域都是属于系统控制（这部分属于 Framework中的SystemUI）。


## 1.设计

通知作为 Android 系统中重要的一部分，有着自己的设计指导。Android 5.0 中提出的 Material Design 特别重要，你应该查看 [Training](https://developer.android.com/training/material/index.html) 中的有关章节。阅读[通知设计指导](https://developer.android.com/design/patterns/notifications.html)学习有关通知的设计知识。

## 2.创建一个通知

你可以在 [NotificationCompat.Builder](https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html) 中制定一些信息，通过 [NotificationCompat.Builder.build()](https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#build()) 创建一个 Notification。通过调用[NotificationManager.notify()]()发布通知。

### 2.1 需要的元素

一个 Notification 必须包含以下元素：
* 一个小的图标，[setSmallIcon()][setSmallIcon]
* 标题，[setContentTitle()][setContentTitle]
* 详细内容，[setContentText()][setContentText]

缺少任何一个通知都不会出现在通知栏上（之前犯过一个错误，没加smallicon，结果只震动不显示通知）。

### 2.2 可选的配置和元素

除了上面三个以外其余的参数都是可选的，更多内容请参考[NotificationCompat.Builder](https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html)。

### 2.3 通知Action

该参数为可选参数，你需要添加至少一个Action。Action可以让用户从通知直接跳转到程序的Activity，以便进一步的操作。

一个通知可以提供多个action，你总是需要提供一个用户点击通知后的action，通常这个action是打开一个Activity。也可以给通知加一个按钮执行额外的动作，例如闹钟的打盹和短信的立即回复功能，这个功能在Android 4.1上实现。如果你添加了额外的按钮，你必须确定他对应的功能都实现了，后面处理兼容性的章节会有详细介绍。

### 2.4 通知的优先级
通知优先级有五个：

|类型|描述|
|--|--|
|MAX|用于在全屏模式下弹出打断类型的通知，非全屏下和 DEFAULT 表现一样|
|HIGH|用于在全屏模式下弹出打断类型的通知，优先级低于 MAX，非全屏下和 DEFAULT 表现一样|
|DEFAULT|默认优先级，普通的通知|
|LOW|用于通知用户一些非紧急的信息|
|MIN|后台通知，例如天气消息等|

MIN 类型的通知不会将通知图标显示在顶栏，MAX 和 HIGH 类型的打断式通知会在全屏的时候前台展示10s。

![](http://7xisp0.com1.z0.glb.clouddn.com/hand_up_notification.gif)

如果先有了 MAX 又来了 HIGH 的通知，那么当前展示的 MAX 将被 HIGH 替代。

![](http://7xisp0.com1.z0.glb.clouddn.com/max_high_notification.gif)

在通知发出来的时候，所有类型的通知都会在下拉菜单第一的位置保持10s，之后位置会按照优先级加时间的顺序排列到已有的通知里。

![](http://7xisp0.com1.z0.glb.clouddn.com/priority_notification.gif)

对于如何正确设计通知的优先级，可以参考[官方文档](https://developer.android.com/design/patterns/notifications.html)

### 2.5 创建一个简单的通知
下面这段代码展示一个当用户点击通知时弹出一个指定的 Activity 简单的例子。代码中使用 [TaskStackBuilder](https://developer.android.com/reference/android/support/v4/app/TaskStackBuilder.html) 创建一个 PendingIntent 来执行打开指定 Activity 的操作
```java
NotificationCompat.Builder builder = new NotificationCompat.Builder(this)
                .setPriority(priority)
                .setContentTitle(title)
                .setSmallIcon(R.drawable.ic_launcher)
                .setContentText(message);

Intent intent = new Intent(this, ActivityNotificationBasic.class);

TaskStackBuilder stackBuilder = TaskStackBuilder.create(this);
// 点击通知执行这个 intent
stackBuilder.addNextIntent(intent);
// 如果在 Manifest 中定义了 parent activity 的话，在这里添加到 parentStack 后，当在通知点开的 Activity 中 back 的时候就会生效，如果没定义则不会生效
stackBuilder.addParentStack(this);

PendingIntent pendingIntent = stackBuilder.getPendingIntent(0,PendingIntent.FLAG_UPDATE_CURRENT);
builder.setContentIntent(pendingIntent);

NotificationManager mNotificationManager =
                (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
mNotificationManager.notify(new Random().nextInt(), builder.build());
```
这就是简单的通知写法，如果不需要点击通知有效果可以不加 Intent。notify 的第一个参数是通知的 id，如果 notify 的是同一个 id，那么就只会有这一个通知每次 notify 的时候都被刷新。

### 2.6 创建一个可展开布局的通知
可展开的布局属于内置的一个 Style，只要设置好就能达到相应的效果。但是这个效果并不兼容 Android 4.1 之前的版本。版本的兼容的问题会在下一节说明。

```java
NotificationCompat.Builder builder = new NotificationCompat.Builder(this);
builder.setSmallIcon(R.drawable.ic_launcher)
        .setContentText("content")
        .setContentTitle("title");

NotificationCompat.InboxStyle inboxStyle = new NotificationCompat.InboxStyle();
inboxStyle.setBigContentTitle("big content title");

inboxStyle.addLine("event 1");
inboxStyle.addLine("event 2");
inboxStyle.addLine("event 3");
inboxStyle.addLine("event 4");

builder.setStyle(inboxStyle);

NotificationManager mNotificationManager =
                (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
mNotificationManager.notify(new Random().nextInt(), builder.build());
```

下面是效果图
![](http://7xisp0.com1.z0.glb.clouddn.com/expanded_notification.gif)

### 2.7 兼容性
就算是用了 support 包，也不是所有的通知功能都可以兼容之前的系统。想要保证最好的兼容性，首先需要使用兼容包中  NotificationCompat.Builder，另外还要注意以下三点：
1.
2.
3.







[setSmallIcon]:https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#setSmallIcon(int)
[setContentTitle]:https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#setContentTitle(java.lang.CharSequence)
[setContentText]:https://developer.android.com/reference/android/support/v4/app/NotificationCompat.Builder.html#setContentText(java.lang.CharSequence)